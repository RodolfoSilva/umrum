box: wercker/nodejs
services:
    - wercker/mongodb
    - wercker/redis
build:
    steps:
        - npm-install
        - npm-install:
            options: grunt-cli
        - script:
            name: project test
            code: |
                node_modules/grunt-cli/bin/grunt unittest
deploy:
    steps:
        - add-to-known_hosts:
            hostname: $PRODUCTION_HOST
        - mktemp:
            envvar: PRIVATEKEY_PATH
        - create-file:
            name: PrivateKey
            filename: $PRIVATEKEY_PATH
            content: $DEPLOY_KEY_PRIVATE
            overwrite: true
            hide-from-log: true
        - create-file:
            name: Deploy Configuration
            filename: deploy.conf
            overwrite: true
            content: |
                [wercker]
                key $PRIVATEKEY_PATH
                forward-agent yes
                user $DEPLOY_USER
                host $PRODUCTION_HOST
                repo git@github.com:frontendbahia/umrum.git
                ref origin/master
                path $DEPLOY_HOME
                post-deploy npm install && sv restart serverjs
                test sleep 5 && wget -qO /dev/null localhost
        - script:
            name: Deploy to $PRODUCTION_HOST
            code: ./deploy wercker
